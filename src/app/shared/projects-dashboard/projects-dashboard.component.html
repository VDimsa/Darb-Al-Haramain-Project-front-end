<div class="image-container" *ngIf="currentMapImage">
  <div #scrollContainer class="scroll-container" (wheel)="onMouseWheel($event)"
       (click)="addStage === 5 ? onDrawBorder($event) : onContainerClick($event)">
    <div #mapContainer class="map-container">
      <!-- Map Image -->
      <img #projectMap
        [src]="showNewMapImage && newPointBoarder && newPointBoarder.pointMap ? newPointBoarder.pointMap : currentMapImage"
        [alt]="activeProject?.name"
        (load)="onImageLoad()"
        (error)="onImageError()"
        [ngClass]="{'pointer': addStage === 1 || addStage === 2 || addStage === 5, 'map-image': true}" />

      <!-- Points overlay -->
      <div
        style="
          position: absolute;
          top: 0;
          right: 0;
          width: 100%;
          height: 100%;
          overflow: hidden;"
        [style.z-index]="!isAddingMode ? '2 !important' : 'auto'"
        *ngIf="!showPartProjectMap">
        <div class="points-dashboard">
          <div #mapPoint
            *ngFor="let point of activeProject?.points"
            [style.left.%]="point.position.x"
            [style.top.%]="point.position.y"
            class="point"
            [ngClass]="{
              'isMega': point.importance === 1,
              'nonVisible': !point.visible,
              'isProject': point.isProject,
              'light-effect': point.importance === 1,
              'selected-effect': selectedPoint === point || selectedProjectPoint === point
            }"
            (click)="onPointClick(point, $event)">
            <i *ngIf="!point.isProject && point.importance === 0"
               [class]="getPointClass(point.type)"
               [id]="point.id"></i>
            <img *ngIf="point.isProject || point.importance === 1"
                 [src]="getMapImageSource(point.logo)"
                 alt="Project Logo"
                 [ngClass]="{
                   'logo': point.isProject
                 }" />
          </div>
        </div>
      </div>

      <!-- SVG for paths -->
      <svg *ngIf="selectedPath && !showPartProjectMap"
           [attr.viewBox]="'0 0 ' + imageWidth + ' ' + imageHeight"
           [style.z-index]="!isAddingMode ? '1 !important' : 'auto'"
           class="path-svg">
        <path *ngFor="let path of selectedPath"
              [attr.d]="path.d"
              fill="none"
              stroke="white"
              stroke-width="2"
              class="animated-path" />
      </svg>

      <!-- SVG for borders -->
      <svg
        class="borders-svg"
        [attr.viewBox]="'0 0 ' + imageWidth + ' ' + imageHeight"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
        [style.z-index]="isAddingMode && addStage === 5 ? '-1 !important' : 'auto'"
        [ngClass]="{
          'nonVisible': isAddingMode && ![5, 6, 7].includes(addStage)
        }"
      >
        <!-- 1) Point-based borders: hide in stage 7 by adding `addStage !== 7` -->
        <ng-container *ngIf="!showPartProjectMap && addStage !== 7">
          <ng-container *ngFor="let point of activeProject?.points">
            <!-- Only render if point is a project (remove `point.isProject` to show borders for all) -->
            <ng-container *ngIf="point.borders && point.isProject">
              <ng-container *ngFor="let border of point.borders">
                <polygon
                  *ngIf="border.Cordinates?.length"
                  [attr.points]="getBorderPoints(border.Cordinates)"
                  fill="rgba(0, 0, 255, 0.2)"
                  stroke="blue"
                  stroke-width="2"
                  [style.stroke]="border.color || 'blue'"
                  [style.fill]="border.color || 'blue'"
                  (click)="onBorderClick(point, $event)"
                ></polygon>
              </ng-container>
            </ng-container>
          </ng-container>
        </ng-container>
      
        <!-- 2) If showPartProjectMap is active, show the selected point's borders -->
        <ng-container *ngIf="showPartProjectMap && selectedBorderPoint && selectedBorderPoint.borders && addStage !== 7">
          <ng-container *ngFor="let border of selectedBorderPoint.borders">
            <polygon
              *ngIf="border.Cordinates?.length && border.visible"
              [attr.points]="getBorderPoints(border.Cordinates)"
              fill="rgba(0, 0, 255, 0.2)"
              stroke="blue"
              stroke-width="2"
              (click)="onPointBorderClick(border, $event)"
              [style.stroke]="border.color || 'blue'"
              [style.fill]="border.color || 'blue'"
            ></polygon>
          </ng-container>
        </ng-container>
      
        <!-- 3) In Stage 7, show the “inside” borders from `projectsMap.data` -->
        <ng-container *ngIf="isAddingMode && addStage === 7 && projectsMap && projectsMap.data">
          <ng-container *ngFor="let data of projectsMap.data">
            <ng-container *ngFor="let border of data.borders">
              <polygon
                *ngIf="border.Cordinates?.length"
                [attr.points]="getBorderPoints(border.Cordinates)"
                fill="rgba(0, 0, 255, 0.2)"
                stroke="blue"
                stroke-width="2"
                (click)="onPointBorderClick(border, $event)"
                [style.stroke]="border.color || 'blue'"
                [style.fill]="border.color || 'blue'"
              ></polygon>
            </ng-container>
          </ng-container>
        </ng-container>
      </svg>

    </div>
  </div>

  <!-- Sidebar -->
  <ul *ngIf="showSidebar" class="list-group side-bar">
    <li class="list-group-item" (click)="clearData()">
      <i class="fa-solid fa-circle-chevron-left"></i>
    </li>
    <li class="list-group-item" (click)="toggleFilters()">
      <i class="fa-solid fa-filter"></i>
    </li>
  </ul>

  <!-- Stage 7: Display Selected ProjectsMap -->
  <div class="filters" *ngIf="addStage === 7 && selectedBorderPoint">
    <h4>الحدود الخاصة بالنقطة المختارة</h4>

    <!-- Display the Project Map -->
    <div *ngIf="selectedBorderPoint.pointMap" class="project-map">
      <h4>خريطة المشروع:</h4>
      <img [src]="getMapImageSource(projectsMap.mapImage)" alt="Project Map Preview" class="preview-img" />
    </div>

    <!-- Show Selected Border Point ID -->
    <div>
      <h4>معرف المشروع:</h4>
      <p>{{ projectsMap.projectId }}</p>
    </div>

    <!-- Show Selected Border Point ID -->
    <div>
      <h4>معرف الحدود:</h4>
      <p>{{ projectsMap.pointId }}</p>
    </div>

    <!-- List the Current Borders -->
    <div>
      <h4>القائمة الحالية للحدود:</h4>
      <ng-container *ngIf="projectsMap.data && projectsMap.data.length > 0">
        <ng-container *ngFor="let data of projectsMap.data">
          <div *ngIf="data.borders && data.borders.length > 0">
            <p>عدد الحدود: {{ data.borders.length }}</p>
    
            <ul>
              <li *ngFor="let border of data.borders; index as i">
                <strong>الحدود {{ i+1 }}: </strong>
                <span *ngIf="border.data && border.data.name"> {{ border.data.name || 'Name' }} </span>
              </li>
            </ul>
          </div>
        </ng-container>
      </ng-container>
    </div>
      
    <!-- UI to show the user the in-progress border and a 'Finish' button -->
    <button class="btn btn-sm btn-primary" (click)="finishCurrentBorder()">
      إنهاء الحدود الحالية
    </button>
  </div>

  <!-- Filters -->
  <div class="filters" *ngIf="!isAddingMode && !showNewMapImage && showFilters && !showPartProjectMap">
    <h4>فلاتر</h4>
    <ul class="list-group">
      <li class="list-group-item" *ngFor="let filter of filterOptions">
        <label>
          <input type="checkbox" checked="true" (change)="onFilterChange(filter.type, $event)" />
          {{ filter.label }}
        </label>
      </li>
    </ul>
  </div>
  <!-- Filters for Point map -->
  <div class="filters" *ngIf="!isAddingMode && showPartProjectMap && showFilters">
    <h4>فلاتر الحدود</h4>
    <p>قم بإظهار أو إخفاء كل حد من الحدود أدناه:</p>
  
    <ul class="list-group">
      <ng-container *ngFor="let border of selectedBorderPoint?.borders; index as i">
        <li class="list-group-item">
          <label>
            <input
              type="checkbox"
              [checked]="border.visible !== false"
              (change)="toggleBorderVisibility(border, i, $event)"
            />
            {{ border.data?.name || ('منطقة ' + (i + 1)) }}
          </label>
        </li>
      </ng-container>
    </ul>
  </div>
</div>
